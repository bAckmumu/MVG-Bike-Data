<!DOCTYPE html>
<html>
<head>
    <title>Leaflet d3 HexBin Layer</title>

    <link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css" />

    <script src="node_modules/d3/build/d3.js" charset="utf-8"></script>
    <script src="node_modules/d3-hexbin/build/d3-hexbin.js" charset="utf-8"></script>
    <script src="node_modules/leaflet/dist/leaflet-src.js"></script>

    <script src="node_modules/@asymmetrik/leaflet-d3/dist/leaflet-d3.js" charset="utf-8"></script>

    <style>
        svg path.hexbin-hexagon {
            stroke: #888;
            stroke-width: 2px;
        }
    </style>

</head>
<body>
    <h2>Leaflet d3 Hexbin Example with Event Handling</h2>
    <p>Demonstrates use of events</p>

    <!-- The map element -->
    <div id="map" style="width: 1000px; height: 750px; border: 1px solid #ccc"></div>
    
    <br/>
    <div id="hovered">
        <label>Hovered: </label>
        <span class="count"></span>
    </div>
    <div id="clicked">
        <label>Last Clicked: </label>
        <span class="count"></span>
    </div>
    
    <br/>
    <button onclick="loadNextDistrict()">Load next district</button>
    

    <script>

        var center = [ 48.1351253, 11.581980599999952 ];
        // var layer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     maxZoom: 18,
        //     attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        // });

        var layer = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
        maxZoom: 20, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
      });

        var map = L.map('map', {
            layers: [ layer ],
            center: L.latLng(center[0], center[1]), zoom: 12
        });

        // Options for the Hexbin
        var options = {
            radius: 24,
            opacity: 0.5,
            // colorRange: [ 'white', 'orange', 'red' ],
            colorRange: ['#fff', '#409A99'],
            // Set overrides for the colorScale's domain extent
            colorScaleExtent: [ 1, 500 ],
            radiusRange: [ 4, 22 ]
        };

        // Create the hexlayer
        var hexLayer = L.hexbinLayer(options);

        // Set up events
        hexLayer.dispatch()
            .on('mouseover', function(d, i) {
                console.log({ type: 'mouseover', event: d, index: i, context: this });
                setHovered(d);
            })
            .on('mouseout', function(d, i) {
                console.log({ type: 'mouseout', event: d, index: i, context: this });
                setHovered();
            })
            .on('click', function(d, i) {
                console.log({ type: 'click', event: d, index: i, context: this });
                setClicked(d);
            });

        // Add it to the map now that it's all set up
        hexLayer.addTo(map);

        function setHovered(d) {
            d3.select('#hovered .count').text((null != d) ? d.length : '');
        }

        function setClicked(d) {
            d3.select('#clicked .count').text((null != d) ? d.length : '');
        }

        var districtIndex = 1;
        function loadNextDistrict() {
            if (districtIndex <= 28) {
                districtIndex = districtIndex + 1;
            }
            else {
                districtIndex = 1;
            }

            loadDistrictHalts(districtIndex);
        }

        //Load halts data
        function loadDistrictHalts(index) {
            d3.json('data/halts/cartodb_id_' + index + '.geo.json', function(error, districtData) {
                hexLayer.data(districtData);
            });
        }

        loadDistrictHalts(districtIndex);

    </script>
</body>
</html>

